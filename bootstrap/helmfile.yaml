---
# yaml-language-server: $schema=https://www.schemastore.org/helmfile.json
helmDefaults:
  cleanupOnFail: true
  wait: true
  waitForJobs: true

repositories:
- name: vsphere-cpi
  url: https://kubernetes.github.io/cloud-provider-vsphere

releases:
- name: cilium
  namespace: kube-system
  chart: oci://ghcr.io/home-operations/charts-mirror/cilium
  version: 1.18.3
  values:
  - "./templates/values.yaml.gotmpl"

- name: vsphere-cpi
  namespace: kube-system
  chart: vsphere-cpi/vsphere-cpi
  version: 1.34
  values:
  - ./templates/values.yaml.gotmpl
  hooks:
  - name: create-vsphere-cloud-configmap
    events:
    - presync
    command: kubectl
    args:
    - apply
    - --server-side
    - --namespace=kube-system
    - --filename=../kubernetes/kube-system/vsphere-cpi/resources/config-map.yaml
    showlogs: true

- name: spegel
  namespace: kube-system
  chart: oci://ghcr.io/spegel-org/helm-charts/spegel
  version: 0.5.1
  values:
  - ./templates/values.yaml.gotmpl
  needs:
  - kube-system/cilium

- name: cert-manager
  namespace: cert-manager
  chart: oci://quay.io/jetstack/charts/cert-manager
  version: v1.19.1
  values:
  - ./templates/values.yaml.gotmpl
  needs:
  - kube-system/spegel

- name: external-secrets
  namespace: external-secrets
  chart: oci://ghcr.io/external-secrets/charts/external-secrets
  version: 0.20.4
  values:
  - ./templates/values.yaml.gotmpl
  needs:
  - cert-manager/cert-manager

- name: onepassword-connect
  namespace: external-secrets
  chart: oci://ghcr.io/bjw-s-labs/helm/app-template
  version: 4.4.0
  values:
  - ./templates/values.yaml.gotmpl
  hooks:
  - name: Apply onePassword Connect Credentials
    events:
    - presync
    command: mise
    args:
    - op:template
    - kubernetes/external-secrets/onepassword-connect/resources/bootstrap.yaml
  - name: Apply ExternalSecret Cluster Store
    events:
    - postsync
    command: kubectl
    args:
    - apply
    - --server-side
    - --field-manager=kustomize-controller
    - --filename=../kubernetes/external-secrets/external-secrets/resources/cluster-secret-store.yaml
    showlogs: true
  needs:
  - external-secrets/external-secrets

- name: flux-operator
  namespace: flux-system
  chart: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator
  version: 0.33.0
  values:
  - ./templates/values.yaml.gotmpl
  needs:
  - external-secrets/onepassword-connect

- name: flux-instance
  namespace: flux-system
  chart: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-instance
  version: 0.33.0
  values:
  - ./templates/values.yaml.gotmpl
  needs:
  - flux-system/flux-operator
